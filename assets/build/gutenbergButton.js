(()=>{"use strict";const t=window.wp.plugins,e=window.wp.editPost,s=window.wp.components,a=window.wp.data,o=window.wp.element,i=window.wp.i18n,l=window.wp.primitives,n=window.ReactJSXRuntime,r=(0,n.jsx)(l.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,n.jsx)(l.Path,{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})}),p=(0,n.jsx)(l.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)(l.Path,{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm.5 16c0 .3-.2.5-.5.5H5c-.3 0-.5-.2-.5-.5V7h15v12zM9 10H7v2h2v-2zm0 4H7v2h2v-2zm4-4h-2v2h2v-2zm4 0h-2v2h2v-2zm-4 4h-2v2h2v-2zm4 0h-2v2h2v-2z"})}),c=({settings:t,onSettingsChange:e,postTypes:a,statusChoices:l,originalPost:r})=>{const[c,u]=(0,o.useState)((()=>{const e={...t};return"same"===t.type&&r?.type&&(e.type=r.type),"same"===t.status&&r?.status&&(e.status=r.status),e})()),[d,m]=(0,o.useState)(!1),[_,g]=(0,o.useState)(""),[h,x]=(0,o.useState)(""),[w,S]=(0,o.useState)(!1),v=window.postDuplicatorVars?.users||[],f=window.postDuplicatorVars?.currentUser,y=f?.id?String(f.id):v.length>0?v[0].value:"",[j,D]=(0,o.useState)(y),[b,C]=(0,o.useState)((new Date).toISOString()),[N,T]=(0,o.useState)(""),P=t=>t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w\-]/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,""),$=t=>P(t),z=(t,s)=>{const a={...c,[t]:s};"timestamp"===t&&"custom"!==s&&(a.customDate=null),u(a),e(a)};(0,o.useEffect)((()=>{if(!w&&r?.title&&r?.slug){const e=t.fullTitle||`${r.title} ${t.title||""}`;g(e.trim());const s=t.fullSlug||`${r.slug}-${t.slug||"copy"}`;x(s);const a="current_user"===t.post_author?String(f?.id||""):String(r.authorId||f?.id||"");D(a);const o=t.customDate||(new Date).toISOString();C(o),T(B(o)),S(!0)}}),[r,w,t,f]),(0,o.useEffect)((()=>{const e={...t};"same"===t.type&&r?.type&&(e.type=r.type),"same"===t.status&&r?.status&&(e.status=r.status),u(e)}),[t,r]);const B=t=>new Date(t).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),H=t=>{C(t),T(B(t)),z("customDate",t)},V=t=>Array.isArray(t)?t:Object.entries(t).map((([t,e])=>({value:t,label:e})));return(0,n.jsxs)(s.__experimentalVStack,{className:"duplicate-settings-fields",spacing:"20px",children:[(0,n.jsxs)(s.__experimentalHStack,{spacing:"16px",alignment:"stretch",children:[(0,n.jsx)(s.TextControl,{label:(0,i.__)("Title","post-duplicator"),value:_,onChange:t=>{if(g(t),!d&&r?.title){const e=$(t);x(e)}z("fullTitle",t)},__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0}),(0,n.jsx)(s.TextControl,{label:(0,i.__)("Slug","post-duplicator"),value:h,onChange:t=>{x(t),m(!0),z("fullSlug",t)},onBlur:()=>{if(h&&""!==h.trim()){const t=P(h);x(t),z("fullSlug",t)}else{const t=$(_);x(t),z("fullSlug",t),m(!1)}},__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0})]}),(0,n.jsxs)(s.__experimentalHStack,{spacing:"16px",alignment:"stretch",children:[(0,n.jsx)(s.SelectControl,{label:(0,i.__)("Post Status","post-duplicator"),value:c.status,options:V(l),onChange:t=>z("status",t),__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0}),(0,n.jsx)(s.SelectControl,{label:(0,i.__)("Post Type","post-duplicator"),value:c.type,options:V(a),onChange:t=>z("type",t),__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0})]}),(0,n.jsxs)(s.__experimentalHStack,{spacing:"16px",alignment:"stretch",children:[(0,n.jsx)(s.SelectControl,{label:(0,i.__)("Post Author","post-duplicator"),value:j||"",options:v,onChange:t=>{D(t),z("selectedAuthorId",parseInt(t))},__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0}),(0,n.jsxs)("div",{style:{flex:1,position:"relative"},children:[(0,n.jsx)(s.TextControl,{label:(0,i.__)("Post Date","post-duplicator"),value:N,onChange:t=>{T(t)},onBlur:()=>{try{const t=new Date(N);if(isNaN(t.getTime()))T(B(b));else{const e=t.toISOString();C(e),T(B(e)),z("customDate",e)}}catch(t){T(B(b))}},__nextHasNoMarginBottom:!0,__next40pxDefaultSize:!0}),(0,n.jsx)(s.Dropdown,{position:"bottom right",popoverProps:{placement:"bottom-end",offset:8},renderToggle:({isOpen:t,onToggle:e})=>(0,n.jsx)(s.Button,{onClick:e,"aria-expanded":t,icon:p,style:{position:"absolute",right:"2px",top:"26px",minWidth:"36px",height:"36px",padding:"0"},variant:"tertiary"}),renderContent:({onClose:t})=>(0,n.jsx)("div",{style:{padding:"16px"},children:(0,n.jsx)(s.DateTimePicker,{currentDate:b,onChange:H,is12Hour:!1})})})]})]})]})},u=({isOpen:t,onClose:e,onDuplicate:a,originalPost:l,defaultSettings:p,postTypes:u,statusChoices:d,siteUrl:m,currentUser:_})=>{const[g,h]=(0,o.useState)(p),[x,w]=(0,o.useState)(!1),[S,v]=(0,o.useState)(!1);(0,o.useEffect)((()=>{t&&(h(p),w(!1))}),[t,p]);const f=()=>{const t="same"===g.type?l.type:g.type;return u[t]||t};if(!t)return null;const y=(0,n.jsx)(s.Button,{icon:r,variant:x?"primary":"secondary",label:x?(0,i.__)("Done Customizing","post-duplicator"):(0,i.__)("Customize Settings","post-duplicator"),onClick:()=>w(!x),size:"small"});return(0,n.jsxs)(s.Modal,{title:l?.title?g.fullTitle?g.fullTitle:`${l.title} ${g.title}`:"",onRequestClose:e,className:"duplicate-post-modal",size:"large",style:{borderRadius:0},headerActions:y,children:[(0,n.jsxs)("div",{className:"duplicate-post-modal__content",style:{paddingBottom:"77px"},children:[(0,n.jsxs)("div",{className:"duplicate-post-modal__preview",children:[(0,n.jsxs)("div",{className:"duplicate-post-modal__preview-item",children:[(0,n.jsx)("span",{className:"duplicate-post-modal__preview-label",children:(0,i.__)("Post Type:","post-duplicator")}),(0,n.jsx)("span",{className:"duplicate-post-modal__preview-value",children:f()})]}),(0,n.jsxs)("div",{className:"duplicate-post-modal__preview-item",children:[(0,n.jsx)("span",{className:"duplicate-post-modal__preview-label",children:(0,i.__)("Post Status:","post-duplicator")}),(0,n.jsx)("span",{className:"duplicate-post-modal__preview-value",children:(()=>{const t="same"===g.status?l.status:g.status;return d[t]||t})()})]}),(0,n.jsxs)("div",{className:"duplicate-post-modal__preview-item",children:[(0,n.jsx)("span",{className:"duplicate-post-modal__preview-label",children:(0,i.__)("Post Date:","post-duplicator")}),(0,n.jsx)("span",{className:"duplicate-post-modal__preview-value",children:(()=>{let t;if(t=g.customDate?new Date(g.customDate).getTime():"duplicate"===g.timestamp&&l.date?new Date(l.date).getTime():Date.now(),g.time_offset){const e=1e3*(86400*parseInt(g.time_offset_days||0)+3600*parseInt(g.time_offset_hours||0)+60*parseInt(g.time_offset_minutes||0)+parseInt(g.time_offset_seconds||0));"newer"===g.time_offset_direction?t+=e:t-=e}const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`})()})]}),(0,n.jsxs)("div",{className:"duplicate-post-modal__preview-item",children:[(0,n.jsx)("span",{className:"duplicate-post-modal__preview-label",children:(0,i.__)("Post Author:","post-duplicator")}),(0,n.jsx)("span",{className:"duplicate-post-modal__preview-value",children:"current_user"===g.post_author?_?.name||(0,i.__)("Current User","post-duplicator"):l?.author?l.author:(0,i.__)("Original Author","post-duplicator")})]}),(0,n.jsxs)("div",{className:"duplicate-post-modal__preview-item",children:[(0,n.jsx)("span",{className:"duplicate-post-modal__preview-label",children:(0,i.__)("Post URL:","post-duplicator")}),(0,n.jsx)("span",{className:"duplicate-post-modal__preview-value duplicate-post-modal__preview-url",children:(()=>{const t=l?.slug?g.fullSlug?g.fullSlug:`${l.slug}-${g.slug||"copy"}`:"";return t&&m?`${m}/${t}/`:""})()})]})]}),x&&(0,n.jsx)("div",{className:"duplicate-post-modal__settings",children:(0,n.jsx)(c,{settings:g,onSettingsChange:h,postTypes:u,statusChoices:d,originalPost:l})})]}),(0,n.jsxs)(s.__experimentalHStack,{alignment:"right",className:"duplicate-post-modal__footer",style:{position:"absolute",bottom:"0px",left:"0",padding:"20px",borderTop:"1px solid rgba(0, 0, 0, 0.1)",background:"#FFF"},children:[(0,n.jsx)(s.Button,{variant:"tertiary",onClick:e,disabled:S,children:(0,i.__)("Cancel","post-duplicator")}),(0,n.jsx)(s.Button,{variant:"primary",onClick:async()=>{v(!0);try{await a(g)}catch(t){console.error("Error duplicating:",t)}finally{v(!1)}},disabled:S,isBusy:S,children:S?(0,i.__)("Duplicating...","post-duplicator"):(()=>{const t=f();return(0,i.__)(`Duplicate ${t}`,"post-duplicator")})()})]})]})};(0,t.registerPlugin)("post-duplicator-button",{render:()=>{const[t,l]=(0,o.useState)(!1),[r,p]=(0,o.useState)(null),[c,d]=(0,o.useState)(!1),{postId:m,postType:_,postStatus:g,postTypeLabel:h,postTitle:x,postSlug:w,postDate:S,postAuthor:v}=(0,a.useSelect)((t=>{const e=t("core/editor"),s=e.getCurrentPost(),a=e.getCurrentPostType(),o=t("core").getPostType(a),i=e.getEditedPostAttribute("author"),l=t("core").getUser(i),n=l?l.name:"Unknown Author";return{postId:s.id,postType:a,postStatus:e.getEditedPostAttribute("status"),postTypeLabel:o?o.labels.singular_name:"Post",postTitle:e.getEditedPostAttribute("title"),postSlug:e.getEditedPostAttribute("slug"),postDate:e.getEditedPostAttribute("date"),postAuthor:n}}),[]);if("publish"!==g||!m)return null;const f={id:m,title:x,type:_,status:g,slug:w,date:S,author:v};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.PluginPostStatusInfo,{className:"m4c-duplicate-post-status-info",children:(0,n.jsxs)("div",{className:"m4c-duplicate-post-wrapper",style:{paddingTop:"16px"},children:[(0,n.jsx)(s.Button,{variant:"secondary",className:"m4c-duplicate-post-gutenberg",onClick:()=>d(!0),disabled:t,children:(0,i.__)(`Duplicate ${h}`,"post-duplicator")}),r&&(0,n.jsx)("div",{className:"m4c-duplicate-error",children:r})]})}),(0,n.jsx)(u,{isOpen:c,onClose:()=>d(!1),onDuplicate:async t=>{l(!0),p(null);try{const e=await fetch(`${postDuplicatorVars.restUrl}duplicate-post`,{method:"POST",headers:{"X-WP-Nonce":postDuplicatorVars.nonce,"Content-Type":"application/json"},body:JSON.stringify({original_id:m,...t})});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to duplicate post")}const s=await e.json();if(s.duplicate_id){const t=`${postDuplicatorVars.siteUrl}/wp-admin/post.php?post=${s.duplicate_id}&action=edit`;window.open(t,"_blank"),l(!1),d(!1)}}catch(t){console.error("Error duplicating post:",t),p(t.message),l(!1)}},originalPost:f,defaultSettings:postDuplicatorVars.defaultSettings,postTypes:postDuplicatorVars.postTypes,statusChoices:postDuplicatorVars.statusChoices,siteUrl:postDuplicatorVars.siteUrl,currentUser:postDuplicatorVars.currentUser})]})}})})();