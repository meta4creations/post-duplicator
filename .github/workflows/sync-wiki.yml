name: Sync Wiki Documentation (Always Run)

# Alternative workflow that runs on every push to main/master
# Use this if the path-filtered workflow isn't triggering reliably

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if help files changed
        id: check-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if echo "$CHANGED_FILES" | grep -q "HELP-.*\.md\|wiki/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Help files or wiki files were changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No help files changed, skipping sync"
          fi

      - name: Checkout wiki
        if: steps.check-files.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync wiki files
        if: steps.check-files.outputs.changed == 'true'
        run: |
          # Copy help files to wiki directory structure
          if [ -f "HELP-DUPLICATING-POSTS.md" ]; then
            echo "Copying HELP-DUPLICATING-POSTS.md to wiki-repo/Duplicating-Posts.md"
            cp HELP-DUPLICATING-POSTS.md wiki-repo/Duplicating-Posts.md
          fi
          
          if [ -f "HELP-SETTINGS.md" ]; then
            echo "Copying HELP-SETTINGS.md to wiki-repo/Settings.md"
            cp HELP-SETTINGS.md wiki-repo/Settings.md
          fi
          
          # Copy any files from wiki/ directory if it exists
          if [ -d "wiki" ]; then
            echo "Copying files from wiki/ directory"
            cp -r wiki/* wiki-repo/ 2>/dev/null || true
          fi

      - name: Create Home page if it doesn't exist
        if: steps.check-files.outputs.changed == 'true'
        run: |
          if [ ! -f "wiki-repo/Home.md" ]; then
            cat > wiki-repo/Home.md << 'EOF'
          # Post Duplicator Documentation

          Welcome to the Post Duplicator plugin documentation.

          ## Getting Started

          - [Duplicating Posts](Duplicating-Posts) - Learn how to duplicate posts using various methods
          - [Settings](Settings) - Configure plugin settings and permissions

          ## Quick Links

          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Issues](https://github.com/${{ github.repository }}/issues)
          EOF
          fi

      - name: Commit and push wiki changes
        if: steps.check-files.outputs.changed == 'true'
        run: |
          cd wiki-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Auto-sync wiki documentation from repository"
            git push
          else
            echo "No changes to commit"
          fi
